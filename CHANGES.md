# 修正履歴 (2025-11-16)

## 修正内容サマリー

### 1. 認証バグの修正 (コミット: 1734821)
**問題**: 認証済みユーザーが通常メッセージを送信すると再度認証を求められる
**修正**: `optimized_auth_flow.py` に認証済みユーザー用の処理を追加
- 認証済みユーザーのメッセージは通常のQ&A処理に進む
- `process_auth_flow()` がFalseを返して通常処理へ

### 2. AI意図理解の改善 (コミット: fe2aa3d)
**問題**: AIが厳格すぎて意味的に類似した質問をマッチできない
**修正**: `qa_service.py` のAIプロンプトと検索ロジックを改善
- 「教えて」「出して」「見せて」などの表現の違いを同一視
- AIが見つからない場合はキーワード検索にフォールバック
- 例: "価格の一覧表を出して" → "価格の一覧表を教えてください" にマッチ

### 3. シート列マッピングの修正 (コミット: 323ba3f, 0ac9f44, 86c5add)
**問題**: コードが期待する列名とシートの実際の列名が一致しない
**修正**: `qa_service.py` で正しい列名をマッピング
- シート構造:
  - A: row_num
  - B: qa_category
  - C: id
  - D: question
  - E: answer
  - F: keywords
  - G: patterns
  - H: tags
  - I: priority
  - J: status
  - K: updated_at
- `tags`列(H)を優先、フォールバックで`qa_category`(B)を使用

### 4. エラーハンドリングの強化 (コミット: b9c772b)
**問題**: 空文字列や無効な値でパースエラーが発生
**修正**: `qa_service.py` に安全な型変換を追加
- `id`と`priority`のint変換を安全に処理
- エラーログを詳細化（エラータイプ、行データを記録）

### 5. フォールバック応答の変更 (コミット: a309f1c, 46a8df7)
**問題**: 回答が見つからない場合、RAGが不正確な汎用回答を生成
**修正**: `app.py` のフォールバックロジックを変更
- RAG汎用回答を無効化
- 候補表示も削除
- フォールバック: "こちらの質問は本社スタッフまでお願いします！"

## 現在の動作フロー

```
ユーザーメッセージ
  ↓
認証チェック
  ↓ 認証済み
フロー検索（会話形式）
  ↓ 該当なし
Q&A検索
  ├─ AI文脈マッチング → 見つかった → 回答返信 ✓
  ├─ キーワード検索 → 見つかった → 回答返信 ✓
  └─ 見つからない → "本社スタッフまでお願いします！" ✓
```

## 技術スタック

- **AI**: Google Gemini API (gemini-2.0-flash-001)
- **データソース**: Google Sheets (qa_items, flows)
- **認証**: Redis (セッション管理)
- **デプロイ**: Railway

## 未解決の問題

**ヘルスチェック失敗** (`qa_healthy=False`)
- 現象: QAサービスの初期化時にエラーが発生
- 調査中: エラーログが空で詳細不明
- 対処: エラーハンドリングを強化済み（次回デプロイで詳細判明予定）

## 次のステップ

1. Railwayデプロイ後、ヘルスチェックのログを確認
2. LINEで動作テスト:
   - 認証フロー
   - Q&A検索（"価格の一覧表を出して"など）
   - フォールバックメッセージ
