# 進捗レポート - 2026年1月21日 (夕方)

## 実施した作業の概要

本日の夕方は、RAGシステムのデータクリーンアップと、AI回答の自然な会話調への改善を行いました。

---

## 1. Supabaseデータベースのクリーンアップ

### 背景
- 過去のデータが重複して保存されていた（403件の文書と403件のEmbedding）
- Google Sheetsからの自動収集データとテストデータが混在
- データベースをクリーンな状態から再スタートする必要があった

### 実施内容

#### 作成したツール: `clear_rag_data.py`

**機能**:
1. **データ一覧表示モード** (`--show`)
   - 現在保存されている文書の一覧を表示
   - ソースタイプ、タイトル、チャンク数、作成日時を表示

2. **データクリアモード** (`--yes` または対話型)
   - `document_embeddings`と`documents`テーブルを完全削除
   - IDシーケンスをリセット（次のデータはID=1から開始）
   - 削除前後のデータ数を表示

**使い方**:
```bash
# データ一覧を表示
python3 clear_rag_data.py --show

# 自動確認モードでクリア
python3 clear_rag_data.py --yes

# 対話型でクリア（確認プロンプトあり）
python3 clear_rag_data.py
```

#### 実行結果

**クリア前のデータ**:
```
1. upload: テスト (1チャンク) - 2026-01-20
2. Google Drive: テスト.pdf (2チャンク) - 2026-01-20
3. Google Sheets: flows (200チャンク) - 2026-01-18
4. Google Sheets: qa_form_log (100チャンク) - 2026-01-18
5. Google Sheets: フォームの回答 3 (100チャンク) - 2026-01-18

合計: 403件の文書と403件のEmbedding
```

**クリア後**:
```
documents: 0件
document_embeddings: 0件
```

✅ データベースが完全にクリーンな状態になりました

---

## 2. RAG回答の自然な会話調への改善

### 問題点

LINEでの回答が機械的で不自然：

**変更前の回答例**:
```
はい、承知いたしました。

1. 結論
今日の天気は晴れです。

2. 手順
提供された文書1に「今日は晴れです」と記載されているため、それを回答としています。

3. 参考情報

【文書1】
タイトル: テスト
内容: === ページ 1 === 今日は晴れです
類似度: 0.689

※この回答はアップロードされた資料から生成されました。
```

### 実施した改善

#### 改善1: プロンプトの変更
**ファイル**: `line_qa_system/rag_service.py:523-560`

**変更内容**:
- 構造化フォーマット（1. 結論、2. 手順、3. 参考情報）を廃止
- 「友達に説明するように、自然で親しみやすい口調で答える」を指示
- 番号付けや見出しを使わない形式に変更

**新しいプロンプト**:
```python
"""
あなたは親しみやすいカスタマーサポート担当者です。以下の資料を参考にして、質問に自然な会話で答えてください。

【質問】
{query}

【参考資料】
{context}

【回答のルール】
- 友達に説明するように、自然で親しみやすい口調で答える
- 「1. 結論」「2. 手順」などの構造化された見出しや番号付けは使わない
- 簡潔に、わかりやすく説明する
- 必要に応じて具体例を挙げる
- 参考資料の情報を基に回答する
- 回答の最後に注意書きなどは付けない（システム側で自動追加されます）
"""
```

#### 改善2: コンテキスト構築の簡素化
**ファイル**: `line_qa_system/rag_service.py:510-521`

**変更前**:
```python
def _build_context(self, documents: List[Dict[str, Any]]) -> str:
    context_parts = []
    for i, doc in enumerate(documents, 1):
        context_parts.append(f"【文書{i}】")
        context_parts.append(f"タイトル: {doc['title']}")
        context_parts.append(f"内容: {doc['content']}")
        context_parts.append(f"類似度: {doc['similarity']:.3f}")
        context_parts.append("")
    return "\n".join(context_parts)
```

**変更後**:
```python
def _build_context(self, documents: List[Dict[str, Any]]) -> str:
    """コンテキストを構築（自然な会話用に簡素化）"""
    # 文書の内容のみを結合（タイトルや類似度などのメタ情報は含めない）
    context_parts = []
    for doc in documents:
        context_parts.append(doc['content'])
    return "\n\n".join(context_parts)
```

### 期待される回答例

**変更後の回答**:
```
今日は晴れですよ！

※この回答はアップロードされた資料から生成されました。
```

✅ シンプルで自然な会話になりました

---

## 3. コミット履歴

```
606ee86 - Improve: RAGの回答を自然な会話調に変更
  - プロンプトを構造化フォーマットから自然な会話調に変更
  - コンテキスト構築時にメタ情報を非表示
  - Supabaseデータクリアスクリプトを追加
```

---

## 4. 成果物

### 新規ファイル
1. **`clear_rag_data.py`** - Supabaseデータクリアスクリプト
   - データ一覧表示機能
   - 自動/対話型クリア機能
   - IDシーケンスリセット機能

### 変更ファイル
1. **`line_qa_system/rag_service.py`**
   - `_build_prompt()`: 自然な会話調プロンプトに変更
   - `_build_context()`: メタ情報を非表示にして簡素化

---

## 5. システムの現在の状態

### デプロイ状況
- **URL**: https://line-qa-system-production.up.railway.app
- **状態**: 正常稼働中
- **最新コミット**: `606ee86`

### データベース状況
```json
{
  "documents": 0,
  "document_embeddings": 0,
  "status": "clean"
}
```

データベースはクリーンな状態で、新しいファイルをアップロードする準備が整っています。

---

## 6. 今後の使い方

### ファイルアップロード

#### 方法1: Webフォーム
```
https://line-qa-system-production.up.railway.app/upload
```

#### 方法2: スクリプト
```bash
./upload_file_to_rag.sh path/to/file.pdf "タイトル"
```

#### 方法3: Google Driveから自動収集
```bash
curl -X POST https://line-qa-system-production.up.railway.app/admin/collect-documents \
  -H "X-API-Key: your_admin_api_key"
```

### データベースのクリア

```bash
# データ一覧を確認
python3 clear_rag_data.py --show

# クリア実行
python3 clear_rag_data.py --yes
```

---

## 7. 技術的な改善点

### Before vs After

| 項目 | 変更前 | 変更後 |
|------|--------|--------|
| **回答スタイル** | 構造化（1.結論、2.手順、3.参考情報） | 自然な会話調 |
| **メタ情報** | タイトル、類似度を表示 | 非表示（内容のみ） |
| **口調** | 機械的・フォーマル | 親しみやすい・自然 |
| **見出し** | 番号付き見出しあり | 見出しなし |
| **データベース** | 403件の重複データ | クリーンな状態（0件） |

---

## 8. 今日の成果まとめ

### 達成したこと
✅ Supabaseデータベースを完全にクリーンアップ（403件→0件）
✅ データクリアスクリプト（clear_rag_data.py）を作成
✅ RAG回答を自然な会話調に改善
✅ メタ情報（タイトル、類似度）を非表示化
✅ プロンプトを構造化フォーマットから会話形式に変更
✅ 変更をRailwayにデプロイ

### 技術的な学び
- RAGシステムのプロンプトエンジニアリング
- 構造化出力vs自然な会話のトレードオフ
- コンテキスト構築の最適化
- PostgreSQL + pgvectorのデータ管理

---

## 9. 改善前後の比較

### 改善前（機械的）
```
はい、承知いたしました。

1. 結論
今日の天気は晴れです。

2. 手順
提供された文書1に「今日は晴れです」と記載されているため、
それを回答としています。

3. 参考情報

【文書1】
タイトル: テスト
内容: === ページ 1 === 今日は晴れです
類似度: 0.689

※この回答はアップロードされた資料から生成されました。
```

### 改善後（自然な会話）
```
今日は晴れですよ！

※この回答はアップロードされた資料から生成されました。
```

✅ 大幅に自然で使いやすい回答になりました！

---

## 10. 次のステップ候補

### UX改善
- ファイルアップロード時の進捗表示改善
- 複数ファイル同時アップロード対応
- ドラッグ&ドロップ対応

### 機能拡張
- 文書削除機能
- 文書検索・フィルタリング機能
- アップロード履歴の表示

### セキュリティ
- ファイルサイズ制限の実装
- レート制限の追加
- オプショナル認証の実装

---

**作成日**: 2026年1月21日 (夕方)
**最終更新**: 2026年1月21日
**作成者**: Claude Code (Anthropic Claude Sonnet 4.5)
