# AIマニュアルBot 統合要件定義書

## 📋 プロジェクト概要

### 🎯 目的
フランチャイズ店舗や社内担当者からの問い合わせ（経理・営業・制作・運用マニュアルなど）を、LINE上で即時に自動回答できる環境を構築する。最終的には、AIがスプレッドシート・マニュアル資料を読み取り、文脈を理解した自然な回答を行う"AIナレッジアシスタント"を目指す。

### 📊 システム規模
- **対象店舗**: 将来的に100店舗
- **対象ユーザー**: 1店舗あたり10人（合計約1,000人）
- **想定質問数**: 月間100件程度（初期フェーズ）
- **デプロイ環境**: Railway（本番稼働中）
- **運用形態**: 24時間365日稼働

### 🎯 期待効果
- **問い合わせ削減**: よくある質問を即自動回答（対応工数−70%）
- **業務効率化**: 知識検索を1分→3秒に短縮
- **店舗支援**: 24時間対応・どの加盟店でも即解決
- **ナレッジ資産化**: スプレッドシートが「生きたマニュアル」に変化
- **継続学習**: 利用ログをもとにBotが成長（AI改善ループ）

### 🎯 運用ポリシー
- **「完璧より、まず動かす」** → Botは"育てるシステム"
- **「追加は誰でも、改善は全員で」** → 運用者がスプレッドシートから管理
- **「人の知恵 × AIのスピード」** → AIが対応し、人が学習する

---

## 🏗️ システム構成

### 全体アーキテクチャ
```
LINE公式アカウント → Flask（LINE Messaging API）
├─ 認証システム（OptimizedAuthFlow）
│   ├─ 店舗コード + 社員番号認証
│   ├─ Redis永続化（Upstash）
│   └─ ステータス管理
├─ qa_service（Q&A検索）
│   ├─ Googleスプレッドシート（qa, flows, store_management, staff_management）
│   ├─ AI候補自動選択（Gemini）
│   └─ 質問ログ記録
├─ flow_service（分岐会話）
│   ├─ AI文脈判断
│   └─ セッション管理
├─ line_client（返信処理）
├─ Redis（セッション・認証状態・キャッシュ）
└─ structlog（JSON形式ログ）
```

### 技術スタック
- **フレームワーク**: Flask（Python 3.11）
- **デプロイ環境**: Railway／Gunicorn
- **データソース**: Google Sheets API／Drive API
- **LLM**: Gemini 1.5 Pro（必須機能）
- **認証状態管理**: Redis（Upstash無料プラン）
- **セッション管理**: Redis
- **検索DB**: PostgreSQL＋pgvector（オプション、RAG機能用）
- **キャッシュ**:
  - データキャッシュ: メモリ（5分TTL）
  - 認証状態: Redis（30日間）
  - セッション: Redis
- **ログ**: structlog（JSON出力、毎日ローテーション）
- **外部連携**: LINE Messaging API v3／Google Apps Script

---

## 📊 データ構造

### シート①：qa（基本Q&A）✅実装済み
**目的**: 基本的なQ&Aデータの管理

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `id` | 整数 | ✅ | Q&AアイテムのユニークID | 101 |
| `question` | 文字列 | ✅ | ユーザーの質問文 | 修正は何回まで可能ですか？ |
| `answer` | 文字列 | ✅ | 質問に対する回答 | 修正は最大3回まで可能です |
| `keywords` | 文字列 | ✅ | 検索キーワード（カンマ区切り） | 修正,リテイク,回数 |
| `synonyms` | 文字列 | ❌ | 同義語（カンマ区切り） | 変更,やり直し |
| `tags` | 文字列 | ✅ | カテゴリタグ（カンマ区切り） | 制作,品質管理 |
| `priority` | 整数 | ✅ | 優先度（1-5） | 3 |
| `status` | 文字列 | ✅ | 表示状態（active/inactive） | active |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/10/13 |

### シート②：flows（分岐ガイド）✅実装済み
**目的**: Yes/No・手順案内型の分岐会話を実現

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `id` | 整数 | ✅ | フローアイテムのユニークID | 201 |
| `trigger` | 文字列 | ✅ | フローを起動するキーワード | 月次締め |
| `step` | 整数 | ✅ | ステップ番号（1から開始） | 1 |
| `question` | 文字列 | ✅ | ユーザーに表示する質問文 | 申請は完了していますか？ |
| `options` | 文字列 | ✅ | 選択肢（全角スラッシュ`／`区切り） | はい／いいえ |
| `next_step` | 文字列 | ✅ | 次のステップ番号（全角スラッシュ`／`区切り） | 2／3 |
| `end` | 真偽値 | ✅ | 終了ステップかどうか（TRUE/FALSE） | FALSE |
| `fallback_next` | 整数 | ✅ | 不正な選択時の移動先ステップ | 999 |
| `updated_at` | 日時 | 任意 | 最終更新日時 | 2025/10/13 |

### シート③：store_management（店舗管理）✅実装済み
**目的**: 店舗情報の管理と認証

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `store_code` | 文字列 | ✅ | 店舗コード | STORE004 |
| `store_name` | 文字列 | ✅ | 店舗名 | 池袋店 |
| `location` | 文字列 | ❌ | 所在地 | 東京都豊島区 |
| `status` | 文字列 | ✅ | 状態（active/inactive） | active |
| `created_at` | 日時 | ✅ | 作成日時 | 2025/01/01 |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/01/14 |

### シート④：staff_management（スタッフ管理）✅実装済み
**目的**: スタッフ情報の管理と認証

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `store_code` | 文字列 | ✅ | 店舗コード | STORE004 |
| `staff_id` | 文字列 | ✅ | 社員番号 | 004 |
| `staff_name` | 文字列 | ✅ | スタッフ名 | 田中太郎 |
| `line_user_id` | 文字列 | ❌ | LINE User ID（認証後に記録） | U1234567890abcdef |
| `status` | 文字列 | ✅ | 状態（active/suspended/inactive） | active |
| `auth_time` | 日時 | ❌ | 最終認証日時 | 2025/01/14 10:30:00 |
| `created_at` | 日時 | ✅ | 作成日時 | 2025/01/01 |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/01/14 |

### シート⑤：query_log（質問ログ）🔄実装予定
**目的**: ユーザーの質問履歴を記録し、分析・改善に活用

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `timestamp` | 日時 | ✅ | 質問日時 | 2025/01/14 10:30:15 |
| `user_id_hash` | 文字列 | ✅ | ユーザーIDハッシュ | hash_U123... |
| `store_code` | 文字列 | ✅ | 店舗コード | STORE004 |
| `staff_name` | 文字列 | ✅ | スタッフ名 | 田中太郎 |
| `question` | 文字列 | ✅ | 質問内容 | 請求書の発行方法 |
| `answer_found` | 真偽値 | ✅ | 回答が見つかったか | TRUE |
| `answer_id` | 文字列 | ❌ | 回答ID | 101 |
| `response_time_ms` | 整数 | ✅ | 応答時間（ミリ秒） | 150 |
| `ai_used` | 真偽値 | ✅ | AI機能を使用したか | TRUE |

### シート⑥：locations（資料ナビ）📋将来実装
**目的**: 関連資料・マニュアルへのナビゲーション（将来の拡張機能）

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `category` | 文字列 | ✅ | カテゴリ分類 | 経理 |
| `title` | 文字列 | ✅ | 資料タイトル | 月次締め手順書 |
| `url` | 文字列 | ✅ | 資料URL | https://docs.google.com/... |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/01/14 |

---

## 🚀 実装ステップ

### 【STEP1】最小構成 ✅完了（2024年）
**期間**: 1日
**内容**:
- LINE上で質問→回答が返る基本機能
- Googleスプレッドシート連携
- 自動キャッシュ更新（5分ごと）
- 管理者パネル（/admin/reload, /admin/stats）

**成果物**:
- 基本Q&A機能
- キーワード・Fuzzy検索
- 管理API

### 【STEP2】分岐会話導入 ✅完了（2024年）
**期間**: 2〜3日
**内容**:
- Yes/No・手順案内が可能な分岐ロジック
- flowsシート追加
- Redis導入（セッション・キャッシュ管理）
- 会話状態の保持と遷移
- クイックリプライ機能

**成果物**:
- FlowService実装
- SessionService実装
- Redis統合

### 【STEP3】認証システム構築 ✅完了・本番稼働中（2025年1月）
**期間**: 2週間
**内容**:
- 店舗コード + 社員番号による二段階認証
- 店舗管理シート（store_management）
- スタッフ管理シート（staff_management）
- ステータス管理（active/suspended/inactive）
- キャッシュベース認証（5分TTL）
- 管理API（認証済みユーザー一覧、認証取り消し等）
- シングルトンパターンによる認証フロー管理

**認証フロー**:
```
1. ユーザー: "認証" と送信
2. Bot: "店舗コードを入力してください"
3. ユーザー: "STORE004" (店舗コード)
4. Bot: 店舗を確認 → "社員番号を入力してください"
5. ユーザー: "004" (社員番号)
6. Bot: スタッフを確認 → "認証が完了しました！"
7. 以降、Bot利用可能
```

**成果物**:
- OptimizedAuthFlow実装（595行）
- StaffService実装（668行）
- StoreService実装（442行）
- 管理用エンドポイント（7個）
- Railway本番環境デプロイ済み

### 【STEP4】AI機能統合 ✅実装完了・稼働中（2025年1月）
**期間**: 1週間
**内容**:
- Gemini API統合（必須機能）
- AI文脈判断によるフロー自動開始
- 複数候補からのAI自動選択
- フォールバック機能（AI失敗時）

**AI機能の3つの役割**:

#### 1. フロー自動開始
**目的**: ユーザーの自然な質問から適切なフローを判断

**例**:
```
ユーザー: "月末の締め作業について教えて"
↓ AI判断
→ 「月次締め」フローを自動開始
→ 最初の質問を表示
```
**フォールバック**: キーワード完全一致

#### 2. 候補自動選択
**目的**: 複数の回答候補から最適な1つを自動選択

**例**:
```
ユーザー: "請求書"
↓ 検索結果（3件）
候補1: 請求書の発行方法
候補2: 請求書の修正方法
候補3: 請求書の再発行について
↓ AI判断
→ ユーザーの文脈に最も合う候補を選択して回答
```
**フォールバック**: 候補を全て表示（ユーザーが選択）

#### 3. RAG回答生成（オプション）
**目的**: 未登録の質問にドキュメントから回答を生成
**前提条件**: PostgreSQL + pgvector環境が必要
**フォールバック**: 「該当する回答が見つかりませんでした」

**コスト試算**:
```
想定: 月間100質問、うち30%でAI使用
- 月間30回 × 70トークン ≒ 2,100トークン
- 月間コスト: 約10円以下（Gemini 1.5 Flash）
```

**成果物**:
- AIService実装（416行）
- RAGService実装（451行）
- Gemini API統合

### 【STEP5】認証状態の永続化 🔄実装予定（今週）
**期間**: 1日
**内容**:
- Upstash Redis統合（無料プラン）
- 認証状態の永続化（アプリ再起動対応）
- セッション管理の強化
- 管理API認証の有効化（X-User-IDヘッダー）
- 質問ログ機能（Google Sheets）

**実装項目**:
1. Redis永続化（30分）
2. 管理API認証（5分）
3. 質問ログ（30分）

**期待効果**:
- アプリ再起動でもユーザーの認証状態が維持
- 管理APIのセキュリティ強化
- ユーザー質問の分析が可能に

### 【STEP6】UX改善 📋実装予定（来週）
**期間**: 1日
**内容**:
- LINEリッチメニューからBotを起動
- ポストバック方式による自然な導線
- 未認証時の案内メッセージ

**実装方式**:
- ポストバック方式（トーク履歴に残らない）
- シンプルなテキストメッセージ
- 既存の公式LINEと共存

### 【STEP7】RAG機能強化 📋将来実装
**期間**: 2〜3週間
**前提条件**: 必要性が確認された後
**内容**:
- PostgreSQL + pgvector構築
- Embedding検索（類似度計算）
- スプレッドシート/Docsから根拠抽出・要約
- DocumentCollector実装

### 【STEP8】運用・分析改善 📋継続
**期間**: 継続
**内容**:
- 定常運用と精度向上
- 質問ログの分析
- 未解決Q・離脱率・回答率を可視化
- 解決率≥80%目標、応答2秒以内
- Q&Aデータの拡充

---

## 🔐 認証・セキュリティ要件

### エンドユーザー認証
**目的**:
- 加盟店スタッフのみがBotを利用できるようにする
- 店舗ごとの利用状況を追跡する
- 退職者や利用停止者のアクセスを制限する

**認証状態の管理**:
- **保存先**: Redis（Upstash）による永続化
- **有効期限**: 30日間（自動延長なし）
- **再起動対応**: アプリ再起動でも認証状態が維持される
- **ステータスチェック**: 毎回のメッセージで自動確認（キャッシュ5分）

**認証が解除される条件**:
| 条件 | タイミング | 動作 |
|-----|----------|------|
| スタッフIDを削除 | キャッシュ更新時（最大5分） | 次回メッセージで「認証が必要です」 |
| statusを"suspended"に変更 | キャッシュ更新時（最大5分） | 次回メッセージで「認証が必要です」 |
| statusを"inactive"に変更 | キャッシュ更新時（最大5分） | 次回メッセージで「認証が必要です」 |
| 管理APIで取り消し | **即座** | 対象ユーザーの認証が即座に解除 |
| 全ユーザーステータスチェック | **即座** | 無効なユーザーを一括解除 |

### 管理者認証
**方式**: X-User-IDヘッダー認証

**対象エンドポイント**:
- `/admin/reload` - キャッシュ再読み込み
- `/admin/stats` - 統計情報取得
- `/admin/authenticated-users` - 認証済みユーザー一覧
- `/admin/force-cache-update` - キャッシュ強制更新
- `/admin/check-all-users-status` - 全ユーザーステータスチェック
- `/admin/deauthenticate` - 認証取り消し

**設定方法**:
```bash
# Railway環境変数
ADMIN_USER_IDS=U1234567890abcdef,U9876543210fedcba
```

**使用方法**:
```bash
curl -X POST https://your-app.railway.app/admin/reload \
  -H "X-User-ID: U1234567890abcdef"
```

### LINE署名検証
- **全リクエストで署名検証を実施**
- 不正なリクエストは400エラーで拒否
- HMAC-SHA256による署名検証

### データ保護
- **暗号化通信**: HTTPS必須
- **アクセス制御**: サービスアカウントによる最小権限アクセス
- **ログ保護**: 構造化ログで機密情報の漏洩防止
- **user_idハッシュ化**: 個人情報保護のためuser_idはハッシュ化して保存
- **PII非保存**: 個人を特定できる情報は最小限に

---

## 🛠️ 運用管理要件

### キャッシュ管理

**自動更新**:
- Q&Aデータ: 5分ごとに自動リロード
- フローデータ: 5分ごとに自動リロード
- 店舗・スタッフデータ: 5分ごとに自動リロード（キャッシュ）

**手動更新**:
```bash
# 全キャッシュを即座に更新
curl -X POST https://your-app.railway.app/admin/force-cache-update \
  -H "X-User-ID: U1234567890abcdef"

# 全ユーザーのステータスをチェック
curl -X POST https://your-app.railway.app/admin/check-all-users-status \
  -H "X-User-ID: U1234567890abcdef"
```

### スタッフ管理フロー

**新規スタッフの追加**:
1. `staff_management`シートに新しい行を追加
2. 必須項目を入力: store_code, staff_id, staff_name, status=active
3. スタッフにLINE Botの使い方を案内
4. スタッフが「認証」コマンドで認証

**スタッフの停止**:
1. `staff_management`シートで該当スタッフの`status`を"suspended"に変更
2. オプション: 管理APIで即座に反映
   ```bash
   curl -X POST https://your-app.railway.app/admin/check-all-users-status \
     -H "X-User-ID: U1234567890abcdef"
   ```
3. 最大5分後、次回メッセージで自動的にアクセス不可

**スタッフの完全削除**:
1. `staff_management`シートから該当行を削除
2. 管理APIで認証を解除
   ```bash
   curl -X POST https://your-app.railway.app/admin/deauthenticate \
     -H "Content-Type: application/json" \
     -H "X-User-ID: U1234567890abcdef" \
     -d '{"user_id": "U1234567890abcdef"}'
   ```

### 統計情報の確認
```bash
# システム統計
curl https://your-app.railway.app/admin/stats \
  -H "X-User-ID: U1234567890abcdef"

# 認証済みユーザー一覧
curl https://your-app.railway.app/admin/authenticated-users \
  -H "X-User-ID: U1234567890abcdef"
```

### 質問ログの分析（STEP5実装後）

**Google Sheetsでの分析**:
```
■ よくある質問TOP10
=QUERY(query_log!A:I, "SELECT E, COUNT(E) GROUP BY E ORDER BY COUNT(E) DESC LIMIT 10")

■ 回答が見つからなかった質問
=FILTER(query_log!A:I, query_log!F:F=FALSE)

■ 店舗別の利用状況
=QUERY(query_log!A:I, "SELECT C, COUNT(C) GROUP BY C ORDER BY COUNT(C) DESC")

■ 平均応答時間
=AVERAGE(query_log!H:H)
```

---

## 📈 運用要件

### パフォーマンス要件
- **応答速度**: 2秒以内目標
- **更新周期**: 5分間隔で自動リロード
- **同時接続**: 100ユーザー同時対応（初期）、将来的に1,000ユーザー対応
- **可用性**: 99.9%以上

### 品質要件
- **解決率**: ≥80%目標
- **離脱率**: ≤10%目標
- **精度**: 類似度スコア0.72以上で回答、0.6以上で候補表示
- **認証完了率**: ≥95%

### 監視・ログ要件
- **構造化ログ**: JSON形式で出力
- **ログローテーション**: 毎日ローテーション
- **ヘルスチェック**: /healthzエンドポイント
- **統計情報**: /admin/statsエンドポイント

---

## 🔧 技術要件

### 開発環境
- **Python**: 3.11以上
- **依存管理**: Poetry
- **テスト**: pytest
- **コード品質**: flake8, black

### 本番環境
- **デプロイ**: Railway
- **WSGI**: Gunicorn
- **プロセス管理**: 自動スケーリング
- **環境変数**: 機密情報の管理

### 外部連携
- **LINE Messaging API**: v3
- **Google Sheets API**: v4
- **Google Drive API**: v3（将来）
- **Upstash Redis**: REST API（認証永続化）

---

## 📋 機能要件

### 基本機能（実装済み）
1. **Q&A検索**: キーワード・Fuzzy検索
2. **分岐会話**: Yes/No・選択肢による対話
3. **AI文脈判断**: 自然言語によるフロー自動開始
4. **AI候補選択**: 複数候補から最適回答の自動選択
5. **認証システム**: 店舗コード + 社員番号認証
6. **ステータス管理**: アカウントの有効化・無効化

### 管理機能（実装済み）
1. **キャッシュ管理**: 手動リロード機能
2. **統計表示**: 利用状況の可視化
3. **ログ監視**: エラー・パフォーマンス監視
4. **設定管理**: 環境変数による設定
5. **認証管理**: ユーザー認証の管理・取り消し

### 実装予定機能
1. **認証永続化**: Redis（Upstash）による状態保存
2. **質問ログ**: ユーザー質問の記録・分析
3. **リッチメニュー**: 既存公式LINEからBot起動
4. **RAG機能**: 文書からの根拠抽出・要約回答（将来）
5. **学習機能**: 利用ログからの改善（将来）
6. **多言語対応**: 国際化対応（将来）
7. **音声対応**: 音声メッセージ処理（将来）

---

## 📊 成功指標

### 定量的指標（初期目標）
- **利用者数**: 月間アクティブユーザー50人以上
- **回答率**: 質問に対する回答率 80%以上
- **応答時間**: 平均応答時間 2秒以内
- **エラー率**: システムエラーの発生率 1%未満
- **認証完了率**: 認証フロー完了率 95%以上

### 定量的指標（1年後目標）
- **利用者数**: 月間アクティブユーザー500人以上
- **回答率**: 質問に対する回答率 90%以上
- **応答時間**: 平均応答時間 1秒以内
- **エラー率**: システムエラーの発生率 0.1%未満

### 定性的指標
- **ユーザー満足度**: アンケート・フィードバック
- **業務効率化**: 問い合わせ削減効果（目標: 70%削減）
- **ナレッジ蓄積**: Q&Aデータベースの成長（目標: 200件以上）
- **運用負荷**: 管理者の作業負荷軽減

---

## 🔄 継続改善

### データドリブン改善
- **利用ログ分析**: よくある質問の特定
- **回答精度向上**: スコアリングアルゴリズムの改善
- **ユーザー行動分析**: 離脱ポイントの特定
- **A/Bテスト**: 回答パターンの最適化

### 機能拡張
- **新カテゴリ追加**: 業務領域の拡大
- **多言語対応**: 国際展開への対応
- **AI機能強化**: より高度な自然言語処理
- **統合機能**: 他システムとの連携

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|----------|--------|
| 2025/10/13 | 1.0 | 初版作成 | AI Assistant |
| 2025/10/13 | 1.1 | Googleフォーム連携除外、AI機能強化に変更 | AI Assistant |
| 2025/01/14 | 2.0 | 認証システム・AI機能の実装完了を反映 | AI Assistant |
| - | - | STEP1完了 | - |
| - | - | STEP2完了 | - |
| - | - | STEP3: 認証システム完了・本番稼働中 | - |
| - | - | STEP4: AI機能統合完了・稼働中 | - |
| - | - | 規模を明記（100店舗×10人=1,000人） | - |
| - | - | 質問ログ・リッチメニュー機能を計画に追加 | - |

---

## 📞 連絡先・サポート

### 技術サポート
- **開発者**: AI Assistant
- **プロジェクト管理**: 要件定義書に基づく開発進行
- **運用サポート**: Railway環境での24時間稼働

### ドキュメント
- **API仕様書**: `docs/API_SPECIFICATION.md`
- **システム構成書**: `docs/SYSTEM_ARCHITECTURE.md`
- **デプロイメントガイド**: `docs/DEPLOYMENT_GUIDE.md`
- **認証システムガイド**: `docs/AUTH_SYSTEM_SETUP.md`
- **各ステップ別ガイド**: `docs/STEP*_*.md`
