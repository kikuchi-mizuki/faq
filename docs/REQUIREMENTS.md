# AIマニュアルBot 統合要件定義書

## 📋 プロジェクト概要

### 🎯 目的
フランチャイズ店舗や社内担当者からの問い合わせ（経理・営業・制作・運用マニュアルなど）を、LINE上で即時に自動回答できる環境を構築する。最終的には、AIがスプレッドシート・マニュアル資料を読み取り、文脈を理解した自然な回答を行う"AIナレッジアシスタント"を目指す。

### 🎯 期待効果
- **問い合わせ削減**: よくある質問を即自動回答（対応工数−70%）
- **業務効率化**: 知識検索を1分→3秒に短縮
- **店舗支援**: 24時間対応・どの加盟店でも即解決
- **ナレッジ資産化**: スプレッドシートが「生きたマニュアル」に変化
- **継続学習**: 利用ログをもとにBotが成長（AI改善ループ）

### 🎯 運用ポリシー
- **「完璧より、まず動かす」** → Botは"育てるシステム"
- **「追加は誰でも、改善は全員で」** → 運用者がフォームからQを追加
- **「人の知恵 × AIのスピード」** → AIが対応し、人が学習する

---

## 🏗️ システム構成

### 全体アーキテクチャ
```
LINE公式アカウント → Flask（LINE Messaging API）
├─ qa_service（Q&A検索）
│   ├─ Googleスプレッドシート（qa, flows, locations, qa_form_log）
│   ├─ Embedding DB（PostgreSQL + pgvector）
│   └─ RAG処理（AI要約）
├─ line_client（返信処理）
├─ Redis（セッション・キャッシュ）
└─ structlog（JSON形式ログ）
```

### 技術スタック
- **フレームワーク**: Flask（Python 3.11）
- **デプロイ環境**: Railway／Gunicorn
- **データソース**: Google Sheets API／Drive API
- **LLM**: OpenAI GPT-4o／Gemini 1.5 Pro
- **検索DB**: PostgreSQL＋pgvector
- **キャッシュ**: Redis
- **ログ**: structlog（JSON出力、毎日ローテーション）
- **外部連携**: LINE Messaging API v3／Google Apps Script

---

## 📊 データ構造

### シート①：qa（基本Q&A）✅実装済み
**目的**: 基本的なQ&Aデータの管理

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `id` | 整数 | ✅ | Q&AアイテムのユニークID | 101 |
| `question` | 文字列 | ✅ | ユーザーの質問文 | 修正は何回まで可能ですか？ |
| `answer` | 文字列 | ✅ | 質問に対する回答 | 修正は最大3回まで可能です |
| `keywords` | 文字列 | ✅ | 検索キーワード（カンマ区切り） | 修正,リテイク,回数 |
| `synonyms` | 文字列 | ❌ | 同義語（カンマ区切り） | 変更,やり直し |
| `tags` | 文字列 | ✅ | カテゴリタグ（カンマ区切り） | 制作,品質管理 |
| `priority` | 整数 | ✅ | 優先度（1-5） | 3 |
| `status` | 文字列 | ✅ | 表示状態（active/inactive） | active |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/10/13 |

### シート②：flows（分岐ガイド）✅STEP2で実装
**目的**: Yes/No・手順案内型の分岐会話を実現

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `id` | 整数 | ✅ | フローアイテムのユニークID | 201 |
| `trigger` | 文字列 | ✅ | フローを起動するキーワード | 月次締め |
| `step` | 整数 | ✅ | ステップ番号（1から開始） | 1 |
| `question` | 文字列 | ✅ | ユーザーに表示する質問文 | 申請は完了していますか？ |
| `options` | 文字列 | ✅ | 選択肢（全角スラッシュ`／`区切り） | はい／いいえ |
| `next_step` | 文字列 | ✅ | 次のステップ番号（全角スラッシュ`／`区切り） | 2／3 |
| `end` | 真偽値 | ✅ | 終了ステップかどうか（TRUE/FALSE） | FALSE |
| `fallback_next` | 整数 | ✅ | 不正な選択時の移動先ステップ | 999 |
| `updated_at` | 日時 | 任意 | 最終更新日時 | 2025/10/13 |

### シート③：locations（資料ナビ）🔄STEP3で実装
**目的**: 関連資料・マニュアルへのナビゲーション

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `category` | 文字列 | ✅ | カテゴリ分類 | 経理 |
| `title` | 文字列 | ✅ | 資料タイトル | 月次締め手順書 |
| `url` | 文字列 | ✅ | 資料URL | https://docs.google.com/... |
| `updated_at` | 日時 | ✅ | 最終更新日時 | 2025/10/13 |

### シート④：qa_form_log（フォーム投稿ログ）🔄STEP3で実装
**目的**: 非エンジニアによるQ&A追加フローの管理

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `timestamp` | 日時 | ✅ | 投稿日時 | 2025/10/13 |
| `question` | 文字列 | ✅ | 投稿された質問 | 新プランの費用 |
| `answer` | 文字列 | ✅ | 投稿された回答 | 月額5,000円です |
| `category` | 文字列 | ✅ | カテゴリ | 営業 |
| `keywords` | 文字列 | ❌ | 検索キーワード | プラン,費用,料金 |
| `approved` | 真偽値 | ✅ | 承認状態（TRUE/FALSE） | FALSE |
| `created_by` | 文字列 | ✅ | 投稿者 | user@example.com |
| `notes` | 文字列 | ❌ | 備考・メモ | 要確認 |

---

## 🚀 実装ステップ

### 【STEP1】最小構成 ✅完了
**期間**: 1日
**内容**:
- LINE上で質問→回答が返る基本機能
- Googleスプレッドシート連携
- 自動キャッシュ更新（5分ごと）
- 管理者パネル（/admin/reload, /admin/stats）

### 【STEP2】分岐会話導入 ✅完了
**期間**: 2〜3日
**内容**:
- Yes/No・手順案内が可能な分岐ロジック
- flowsシート追加
- Redis導入（セッション・キャッシュ管理）
- 会話状態の保持と遷移

### 【STEP3】Googleフォーム連携 🔄実装中
**期間**: 1週間
**内容**:
- 非エンジニアでもQ追加可能な仕組み
- locationsシート追加（資料ナビ）
- qa_form_logシート追加（フォーム投稿ログ）
- Google Apps Script連携

### 【STEP4】AI要約（RAG）導入 📋予定
**期間**: 2〜3週間
**内容**:
- AIが文脈理解して回答
- PostgreSQL + pgvector導入
- Embedding検索（類似度計算）
- LLM連携（GPT-4o mini or Gemini 1.5）
- スプレッドシート/Docsから根拠抽出・要約

### 【STEP5】運用・分析改善 📋予定
**期間**: 継続
**内容**:
- 定常運用と精度向上
- ユーザー質問・スコア・回答率を記録
- 未解決Q・離脱率・回答率を可視化
- 解決率≥80%目標、応答2秒以内

---

## 🛡️ セキュリティ要件

### 認証・認可
- **LINE公式チャネル署名検証**: 全リクエストで署名検証を実施
- **管理者ヘッダ認証**: X-User-IDヘッダによる管理者認証
- **user_idハッシュ化**: 個人情報保護のためuser_idはハッシュ化して保存
- **PII非保存**: 個人を特定できる情報は保存しない

### データ保護
- **暗号化通信**: HTTPS必須
- **アクセス制御**: サービスアカウントによる最小権限アクセス
- **ログ保護**: 構造化ログで機密情報の漏洩防止

---

## 📈 運用要件

### パフォーマンス要件
- **応答速度**: 2秒以内目標
- **更新周期**: 5分間隔で自動リロード
- **同時接続**: 100ユーザー同時対応
- **可用性**: 99.9%以上

### 品質要件
- **解決率**: ≥80%目標
- **離脱率**: ≤10%目標
- **精度**: 類似度スコア0.8以上で回答、0.6以上で候補表示

### 監視・ログ要件
- **構造化ログ**: JSON形式で出力
- **ログローテーション**: 毎日ローテーション
- **ヘルスチェック**: /admin/healthzエンドポイント
- **統計情報**: /admin/statsエンドポイント

---

## 🔧 技術要件

### 開発環境
- **Python**: 3.11以上
- **依存管理**: Poetry
- **テスト**: pytest
- **コード品質**: flake8, black

### 本番環境
- **デプロイ**: Railway
- **WSGI**: Gunicorn
- **プロセス管理**: 自動スケーリング
- **環境変数**: 機密情報の管理

### 外部連携
- **LINE Messaging API**: v3
- **Google Sheets API**: v4
- **Google Drive API**: v3
- **Google Apps Script**: フォーム連携

---

## 📋 機能要件

### 基本機能
1. **Q&A検索**: キーワード・類似度検索
2. **分岐会話**: Yes/No・選択肢による対話
3. **資料ナビ**: 関連資料へのリンク提供
4. **フォーム連携**: 非エンジニアによるQ&A追加

### 管理機能
1. **キャッシュ管理**: 手動リロード機能
2. **統計表示**: 利用状況の可視化
3. **ログ監視**: エラー・パフォーマンス監視
4. **設定管理**: 環境変数による設定

### 将来機能（STEP4以降）
1. **AI要約**: RAGによる文脈理解回答
2. **学習機能**: 利用ログからの改善
3. **多言語対応**: 国際化対応
4. **音声対応**: 音声メッセージ処理

---

## 📊 成功指標

### 定量的指標
- **利用者数**: 月間アクティブユーザー数
- **回答率**: 質問に対する回答率
- **応答時間**: 平均応答時間
- **エラー率**: システムエラーの発生率

### 定性的指標
- **ユーザー満足度**: アンケート・フィードバック
- **業務効率化**: 問い合わせ削減効果
- **ナレッジ蓄積**: Q&Aデータベースの成長
- **運用負荷**: 管理者の作業負荷軽減

---

## 🔄 継続改善

### データドリブン改善
- **利用ログ分析**: よくある質問の特定
- **回答精度向上**: スコアリングアルゴリズムの改善
- **ユーザー行動分析**: 離脱ポイントの特定
- **A/Bテスト**: 回答パターンの最適化

### 機能拡張
- **新カテゴリ追加**: 業務領域の拡大
- **多言語対応**: 国際展開への対応
- **AI機能強化**: より高度な自然言語処理
- **統合機能**: 他システムとの連携

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|----------|--------|
| 2025/10/13 | 1.0 | 初版作成 | AI Assistant |
| - | - | STEP1完了 | - |
| - | - | STEP2完了 | - |
| - | - | STEP3実装中 | - |

---

## 📞 連絡先・サポート

### 技術サポート
- **開発者**: AI Assistant
- **プロジェクト管理**: 要件定義書に基づく開発進行
- **運用サポート**: 24時間監視・自動復旧

### ドキュメント
- **API仕様書**: `docs/API_SPECIFICATION.md`
- **システム構成書**: `docs/SYSTEM_ARCHITECTURE.md`
- **デプロイメントガイド**: `docs/DEPLOYMENT_GUIDE.md`
- **各ステップ別ガイド**: `docs/STEP*_*.md`
