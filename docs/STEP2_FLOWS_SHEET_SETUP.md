# STEP2: flowsシート追加手順書

## 📋 概要

分岐会話機能（STEP2）を使用するために、Googleスプレッドシートに`flows`シートを追加する手順を説明します。

---

## 🎯 目的

- Yes/No・手順ガイド型の分岐会話を実現
- ユーザーとの対話形式で情報を収集・案内

---

## 📊 flowsシートの構造

### カラム定義

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|---|------|------|---|
| `id` | 整数 | ✅ | フローアイテムのユニークID | 201 |
| `trigger` | 文字列 | ✅ | フローを起動するキーワード | 月次締め |
| `step` | 整数 | ✅ | ステップ番号（1から開始） | 1 |
| `question` | 文字列 | ✅ | ユーザーに表示する質問文 | 申請は完了していますか？ |
| `options` | 文字列 | ✅ | 選択肢（全角スラッシュ`／`区切り） | はい／いいえ |
| `next_step` | 文字列 | ✅ | 次のステップ番号（全角スラッシュ`／`区切り） | 2／3 |
| `end` | 真偽値 | ✅ | 終了ステップかどうか（TRUE/FALSE） | FALSE |
| `fallback_next` | 整数 | ✅ | 不正な選択時の移動先ステップ | 999 |
| `updated_at` | 日時 | 任意 | 最終更新日時 | 2025/10/13 |

---

## 🛠️ 作成手順

### 1. Googleスプレッドシートを開く

既存の`SHEET_ID_QA`で指定されているスプレッドシートを開きます。

### 2. 新しいシートを追加

- シート下部の「+」ボタンをクリック
- シート名を **`flows`** に変更（正確に入力してください）

### 3. ヘッダー行を作成

1行目に以下のヘッダーを入力：

```
id	trigger	step	question	options	next_step	end	fallback_next	updated_at
```

### 4. サンプルデータを入力

以下は「月次締め」フローの例です：

| id | trigger | step | question | options | next_step | end | fallback_next | updated_at |
|----|---------|------|----------|---------|-----------|-----|---------------|------------|
| 201 | 月次締め | 1 | 申請は完了していますか？ | はい／いいえ | 2／3 | FALSE | 999 | 2025/10/13 |
| 202 | 月次締め | 2 | 承認されましたか？ | はい／いいえ | 10／11 | FALSE | 999 | 2025/10/13 |
| 203 | 月次締め | 3 | 申請フォームを開きますか？ | はい／いいえ | 20／999 | FALSE | 999 | 2025/10/13 |
| 210 | 月次締め | 10 | 処理が完了しました。ご確認ください。 | - | - | TRUE | 999 | 2025/10/13 |
| 211 | 月次締め | 11 | 承認待ちです。上長に確認してください。 | - | - | TRUE | 999 | 2025/10/13 |
| 220 | 月次締め | 20 | 申請フォームはこちらです：https://example.com/form | - | - | TRUE | 999 | 2025/10/13 |
| 999 | 月次締め | 999 | 入力が正しくありません。もう一度お試しください。 | - | - | TRUE | 999 | 2025/10/13 |

---

## 📝 フロー設計のルール

### ✅ DO（推奨）

1. **step 1から開始**
   - 各フローの最初のステップは必ず`step=1`にする

2. **triggerを統一**
   - 同じフロー内の全ステップは同じ`trigger`を使用

3. **終了ステップには`end=TRUE`**
   - フローの最後（回答表示）は`end=TRUE`に設定

4. **fallback_nextを設定**
   - ユーザーの入力が想定外の場合の移動先を指定（通常は999番でエラーメッセージ）

5. **選択肢は全角スラッシュ区切り**
   - `options`と`next_step`は対応させる
   - 例：`はい／いいえ` → `2／3`（1番目の選択肢は2へ、2番目は3へ）

### ❌ DON'T（非推奨）

1. **step番号の重複**
   - 同じtrigger内で同じstep番号を使わない

2. **無限ループ**
   - 必ず終了ステップ（`end=TRUE`）に到達するように設計

3. **選択肢とnext_stepの数が不一致**
   - `options`が2つなら`next_step`も2つ必要

---

## 🎬 動作例

### ユーザーとの対話フロー

```
【ユーザー】月次締め

【Bot】申請は完了していますか？
       [はい] [いいえ]

【ユーザー】はい

【Bot】承認されましたか？
       [はい] [いいえ]

【ユーザー】いいえ

【Bot】承認待ちです。上長に確認してください。
```

---

## 🧪 テスト方法

### 1. シートを作成後、アプリをリロード

```bash
curl -X POST https://your-app.railway.app/admin/reload
```

または、5分待って自動リロードを待つ

### 2. LINEで動作確認

1. トリガーワード（例：`月次締め`）を送信
2. クイックリプライで選択肢が表示されることを確認
3. 選択肢をタップして次のステップに進むことを確認
4. 終了ステップまで正しく動作することを確認

### 3. キャンセル機能のテスト

フロー途中で「キャンセル」と送信すると会話が終了することを確認

---

## 🔧 トラブルシューティング

### flowsシートが読み込まれない

- シート名が正確に`flows`になっているか確認
- ヘッダー行が正しいか確認
- サービスアカウントにシートの読み取り権限があるか確認

### フローが開始されない

- `trigger`が正しく設定されているか確認
- `step=1`のデータが存在するか確認
- ログを確認：`/admin/stats`でエラーを確認

### 選択肢が表示されない

- `options`が全角スラッシュ`／`で区切られているか確認
- クイックリプライの制限（最大13個）を超えていないか確認

### 次のステップに進まない

- `next_step`の番号が存在するか確認
- `next_step`とoptionsの数が一致しているか確認

---

## 📚 参考：複雑なフロー例

### 例：カスタマーサポートフロー

| id | trigger | step | question | options | next_step | end | fallback_next |
|----|---------|------|----------|---------|-----------|-----|---------------|
| 301 | サポート | 1 | どのような問題ですか？ | ログインできない／エラーが出る／その他 | 2／3／4 | FALSE | 999 |
| 302 | サポート | 2 | パスワードをリセットしますか？ | はい／いいえ | 10／11 | FALSE | 999 |
| 303 | サポート | 3 | エラーコードを教えてください | E001／E002／その他 | 20／21／22 | FALSE | 999 |
| 304 | サポート | 4 | お問い合わせフォームからご連絡ください | - | - | TRUE | 999 |
| 310 | サポート | 10 | リセットリンクを送信しました | - | - | TRUE | 999 |
| ... | ... | ... | ... | ... | ... | ... | ... |

---

## ✅ チェックリスト

- [ ] `flows`シートを作成した
- [ ] ヘッダー行を正しく入力した
- [ ] 少なくとも1つのフローを作成した
- [ ] step=1から開始している
- [ ] 終了ステップに`end=TRUE`を設定した
- [ ] fallback_nextを設定した
- [ ] アプリをリロードした
- [ ] LINEで動作確認した

---

## 🎉 完了！

これでSTEP2（分岐会話機能）のセットアップが完了しました。

次のステップ：**STEP3 - Googleフォーム連携**

