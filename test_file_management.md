# ファイル管理機能のテストガイド

## 新しく追加された機能

### 1. ファイル一覧表示機能
- **エンドポイント**: `GET /documents`
- **認証**: 不要（誰でもアクセス可能）
- **機能**: データベースに登録されているファイル一覧を取得

**レスポンス例**:
```json
{
  "status": "success",
  "total_documents": 3,
  "documents": [
    {
      "source_type": "upload",
      "source_id": "upload_abc123",
      "title": "製品マニュアル.pdf",
      "chunk_count": 5,
      "last_updated": "2026-01-24 10:30:00"
    }
  ]
}
```

### 2. ファイル削除機能
- **エンドポイント**: `POST /delete-document`
- **認証**: 不要（レート制限あり: 1時間に10回まで）
- **機能**: 指定されたファイルをデータベースから削除

**リクエスト例**:
```json
{
  "source_id": "upload_abc123",
  "source_type": "upload"
}
```

**レスポンス例**:
```json
{
  "status": "success",
  "message": "文書を削除しました（5件の文書、5件のEmbedding）",
  "deleted_documents": 5,
  "deleted_embeddings": 5
}
```

### 3. Web UI の改善
- **URL**: `https://your-app.railway.app/upload`
- **機能**:
  - タブ切り替え UI（アップロード / 一覧表示）
  - ファイル一覧表示
  - 各ファイルに削除ボタン付き
  - 削除確認ダイアログ
  - リアルタイム更新

## テスト手順

### ローカルでのテスト

1. **サーバー起動**:
```bash
python3 start.py
```

2. **ブラウザでアクセス**:
```
http://localhost:5000/upload
```

3. **ファイルアップロードのテスト**:
   - 「アップロード」タブでファイルを選択
   - タイトルを入力（オプション）
   - 「アップロード」ボタンをクリック
   - 成功メッセージが表示されることを確認

4. **ファイル一覧表示のテスト**:
   - 「一覧表示」タブに切り替え
   - アップロードしたファイルが表示されることを確認
   - ファイル情報（タイトル、チャンク数、最終更新日時）が正しく表示されることを確認

5. **ファイル削除のテスト**:
   - ファイルの「削除」ボタンをクリック
   - 確認ダイアログが表示されることを確認
   - 「OK」をクリック
   - 削除成功メッセージが表示されることを確認
   - ファイル一覧から削除されたファイルが消えることを確認

### Railway（本番環境）でのテスト

1. **デプロイ**:
```bash
git add line_qa_system/app.py
git commit -m "Feature: ファイル一覧表示と削除機能を追加"
git push origin main
```

2. **Railway で自動デプロイを待つ**

3. **ブラウザでアクセス**:
```
https://line-qa-system-production.up.railway.app/upload
```

4. **上記のテスト手順を実行**

## セキュリティ機能

### レート制限
- アップロードと削除の合計で1時間あたり10回まで
- IPアドレスベースで制限
- 超過時は HTTP 429 エラーを返却

### データベーストランザクション
- 削除時は `document_embeddings` と `documents` を同時に削除
- エラー時は自動ロールバック

### 削除確認
- WebUI上で削除前に確認ダイアログを表示
- 誤操作を防止

## API仕様

### GET /documents
アップロードされたファイルの一覧を取得

**パラメータ**: なし

**レスポンス**:
- 200: 成功
- 503: RAGサービスが無効

### POST /delete-document
ファイルを削除

**パラメータ**:
```json
{
  "source_id": "string (必須)",
  "source_type": "string (オプション)"
}
```

**レスポンス**:
- 200: 削除成功
- 400: パラメータエラー
- 404: ファイルが見つからない
- 429: レート制限超過
- 503: RAGサービスが無効

## トラブルシューティング

### ファイルが表示されない
- RAGサービスが有効か確認: `/admin/rag-status`
- データベース接続を確認
- ブラウザのコンソールでエラーを確認

### 削除できない
- レート制限を超えていないか確認（1時間に10回まで）
- データベース接続を確認
- ネットワークエラーがないか確認

### アップロードできない
- ファイルサイズが10MB以下か確認
- 対応形式（PDF, Excel, テキスト）か確認
- レート制限を超えていないか確認
